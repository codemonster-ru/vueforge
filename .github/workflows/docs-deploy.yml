name: docs deploy

on:
    workflow_run:
        workflows:
            - publish to NPM
        types:
            - completed
    workflow_dispatch:
        inputs:
            ref:
                description: 'Git ref to deploy manually. Leave empty to deploy the current default branch state.'
                required: false
                default: ''

concurrency:
    group: docs-deploy
    cancel-in-progress: false

jobs:
    deploy-docs:
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.ref) || github.event.workflow_run.head_sha }}

            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - run: npm ci

            - run: npm run build:docs

            - name: Deploy docs over FTP/FTPS
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.DOCS_FTP_HOST }}
                  username: ${{ secrets.DOCS_FTP_USERNAME }}
                  password: ${{ secrets.DOCS_FTP_PASSWORD }}
                  port: ${{ secrets.DOCS_FTP_PORT || 21 }}
                  protocol: ${{ secrets.DOCS_FTP_PROTOCOL || 'ftps' }}
                  local-dir: dist/docs/
                  server-dir: ${{ secrets.DOCS_FTP_SERVER_DIR }}/
